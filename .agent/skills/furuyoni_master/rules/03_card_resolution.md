# カード使用・ダメージ解決・対応の処理チェーン

カードの使用から効果解決までの**厳密な手順**を定義する。
特に攻撃と対応の解決順序は頻出の裁定ポイントであり、正確な理解が必須。

---

## 1. カードの分類

### タイプ（カードの性質）
| タイプ | 説明 |
|:---|:---|
| **通常札** | 山札から引いて手札として使用する。デッキ中に7枚。 |
| **切札** | フレアを支払って使用する必殺技。デッキ中に3枚。手元に公開して置く。 |

### サブタイプ（カードの効果分類）
| サブタイプ | 説明 |
|:---|:---|
| **攻撃** | 適正距離を持ち、ダメージ(X/Y)を与える。 |
| **行動** | 効果テキストを即座に解決する。 |
| **付与** | 桜花結晶を載せて場に展開する。結晶が0になると捨て札。 |

### 属性（追加の特性）
| 属性 | 説明 |
|:---|:---|
| **対応** | 相手の攻撃に対して割り込み使用できる。 |
| **全力** | 使用するとそのターンのメインフェイズが終了する（排他的）。 |

---

## 2. カード使用の基本手順

### 通常札の使用
1. 手札から1枚を選び、公開して使用を宣言する。
2. カードのサブタイプに応じた処理を行う。
3. 使用後、カードは**捨て札**になる（付与を除く）。

### 切札の使用
1. 未使用の切札を選び、使用を宣言する。
2. **フレアコストを支払う**（自フレアからダストへ結晶を移動）。
3. カードのサブタイプに応じた処理を行う。
4. 使用後、カードは**使用済み**になる（再使用不可、特殊効果で戻る場合を除く）。

---

## 3. 攻撃の解決（最重要セクション）

攻撃カードが使用された場合、以下の手順を**この順序で**処理する。

### Step 1: 適正距離チェック
- 攻撃カードには**適正距離**が記載されている（例: 3-4、5-8）。
- 現在の**間合**が適正距離に含まれていれば攻撃は有効。
- 含まれていなければ**攻撃は失敗**（打ち消しではなく、不発として処理）。
- 適正距離修正がある場合は `05_rulings.md` の順序で適用してから判定。

### Step 2: 対応ウィンドウ
- 攻撃が有効な場合、**非ターンプレイヤー**（攻撃を受ける側）に**対応の使用機会**が与えられる。
- 対応属性を持つカードを使用可能（手札からの通常札、または未使用の切札）。
- **対応を使用しない選択も可能**。

### Step 3: 対応の解決
- 対応カードが使用された場合、**対応カードの効果を先に完全解決**する。
- 対応カードが攻撃サブタイプの場合：対応攻撃のダメージ解決 → 元の攻撃のダメージ解決 の順。
- 対応カードの効果により元の攻撃が打ち消される場合がある（例: ダメージを-1する、攻撃を無効にする等）。

### Step 4: ダメージ数値の確定
- 基本ダメージ(X/Y)に、すべての修正（バフ、デバフ、付与効果など）を適用する。
- 修正の適用順は、原則として発生順（付与 → カード効果 → 追加効果）。

### Step 5: ダメージの適用
- **受け手（被攻撃者）が選択**: オーラで X 点受ける or ライフで Y 点受ける。
- **オーラが X 未満の場合**: ライフ受けが強制。
- 結晶の移動については `02_crystal_movement.md` を参照。

### Step 6: 攻撃後効果
- カードに「【攻撃後】」テキストがある場合、ダメージ適用後にその効果を解決する。

### 全体の解決順序図

```
攻撃カード使用
  │
  ├─ 適正距離チェック ──(不適正)──→ 不発（何も起こらない）
  │         │
  │       (適正)
  │         │
  │         ▼
  │    対応ウィンドウ（受け手が対応カードを使用するか選択）
  │         │
  │    ┌────┴────┐
  │  対応あり    対応なし
  │    │           │
  │  対応解決       │
  │    │           │
  │    └────┬────┘
  │         │
  │    ダメージ数値確定
  │         │
  │    ダメージ適用（受け手がオーラ/ライフ選択）
  │         │
  │    攻撃後効果
  │         │
  │         ▼
  │      解決完了
```

---

## 4. 付与札の処理

### 使用時
1. 付与札を使用すると、場に**展開**される。
2. カードに記載された**納（おさめ）**の数だけ、**ダストから桜花結晶を取り、カード上に配置**する。
   - ダストに結晶が不足する場合は、可能な限り配置する。
3. 付与札の「【展開時】」効果がある場合は即座に解決する。

### 維持
- 毎ターンの**開始フェイズ Step 2** で、カード上の結晶が1つダストへ移動する。

### 破棄
- 結晶が**0**になった付与札は**捨て札**になる。
- 「【破棄時】」効果がある場合は、捨て札になる際に解決する。

### 展開中の効果
- 付与札のテキストに「【展開中】」とある効果は、カードが場に出ている間ずっと有効。

---

## 5. 行動札の処理

1. 行動札を使用すると、テキストに記載された効果を**即座に解決**する。
2. 解決後、通常札なら捨て札に、切札なら使用済みに。

---

## 6. 複数攻撃の処理

1ターンに複数の攻撃を行う場合：
- 各攻撃は**個別に**上記のフローを完全解決してから、次の攻撃を処理する。
- **連火**カウントが関わる場合：そのターンに使用した**カードの枚数**をカウントする（3枚目以降で連火条件を満たす）。
